@model List<CartItem>

@{
    ViewData["Title"] = "Shopping Cart";
    var cartTotal = Model.Sum(item => item.Total);
}

<div class="container py-4">
    <h2 class="mb-4">Shopping Cart</h2>

    @if (!Model.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted"></i>
            <h3 class="mt-3">Your cart is empty</h3>
            <p class="text-muted">Add some products to get started!</p>
            <a asp-controller="Products" asp-action="Index" class="btn btn-primary">
                Continue Shopping
            </a>
        </div>
    }
    else
    {
        <!-- Cart Timer -->
        <div class="alert alert-warning mb-4" id="cartTimer">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <i class="bi bi-clock-history"></i>
                    <strong>Your cart is reserved for:</strong>
                </div>
                <div class="cart-countdown-timer">
                    <span class="time-badge"><span id="cartMinutes">15</span>m</span>
                    <span class="time-badge"><span id="cartSeconds">00</span>s</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-body">
                        @foreach (var item in Model)
                        {
                            <div class="cart-item mb-3 pb-3 border-bottom">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <img src="@item.ImageUrl" class="img-fluid rounded" alt="@item.ProductName">
                                    </div>
                                    <div class="col-md-4">
                                        <h5>@item.ProductName</h5>
                                        <p class="text-muted mb-0">$@item.Price each</p>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <button class="btn btn-outline-secondary btn-sm update-qty" data-product-id="@item.ProductId" data-action="decrease">-</button>
                                            <input type="number" class="form-control form-control-sm text-center qty-input" value="@item.Quantity" min="1" readonly>
                                            <button class="btn btn-outline-secondary btn-sm update-qty" data-product-id="@item.ProductId" data-action="increase">+</button>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <strong class="text-primary">$@item.Total</strong>
                                    </div>
                                    <div class="col-md-1">
                                        <button class="btn btn-sm btn-outline-danger remove-item" data-product-id="@item.ProductId">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <a asp-controller="Products" asp-action="Index" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Continue Shopping
                </a>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Order Summary</h5>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>$@cartTotal</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span class="text-success">FREE</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax:</span>
                            <span>$@(Math.Round(cartTotal * 0.1m, 2))</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <strong>Total:</strong>
                            <strong class="text-primary fs-4">$@(Math.Round(cartTotal * 1.1m, 2))</strong>
                        </div>

                        <a asp-controller="Checkout" asp-action="Index" class="btn btn-primary w-100 btn-lg mb-3">
                            Proceed to Checkout
                        </a>

                        <!-- Trust Badges -->
                        <div class="trust-badges-small mt-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-shield-check text-success me-2"></i>
                                <small>Secure Checkout</small>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-truck text-primary me-2"></i>
                                <small>Free Shipping on Orders $50+</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-arrow-repeat text-info me-2"></i>
                                <small>30-Day Money Back Guarantee</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="card mt-3">
                    <div class="card-body text-center">
                        <small class="text-muted d-block mb-2">We Accept:</small>
                        <div class="payment-methods">
                            <i class="bi bi-credit-card fs-4 me-2"></i>
                            <i class="bi bi-paypal fs-4 me-2"></i>
                            <i class="bi bi-wallet2 fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="~/js/cart-timer.js"></script>
    <script>
        // Initialize cart timer (15 minutes)
        initCartTimer(15);

        // Update quantity
        document.querySelectorAll('.update-qty').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                const action = this.dataset.action;
                const qtyInput = this.closest('.input-group').querySelector('.qty-input');
                let newQty = parseInt(qtyInput.value);

                if (action === 'increase') {
                    newQty++;
                } else if (action === 'decrease' && newQty > 1) {
                    newQty--;
                }

                fetch('/Cart/UpdateQuantity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productId: parseInt(productId), quantity: newQty })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            });
        });

        // Remove item
        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', function() {
                if (confirm('Remove this item from cart?')) {
                    const productId = this.dataset.productId;
                    fetch('/Cart/RemoveFromCart', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ productId: parseInt(productId) })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        }
                    });
                }
            });
        });
    </script>
}
